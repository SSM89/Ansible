---
- name: Installer TaniumClient depuis GitLab RHEL
  hosts: all
  become: yes

  vars:
    install_script: "install_tanium_rhel.sh"
    local_dir: "{{ playbook_dir }}"
    tanium_dat: "tanium-init-{{ tanium_env }}.dat"
    remote_dir: "/tmp/tanium-install"

  tasks:
    - name: Stopper le service taniumclient
      systemd_service:
        state: stopped
        name: taniumclient
      tags:
        - restart
        - uninstall

    - name: Désinstaller TaniumClient
      dnf:
        name: TaniumClient
        state: absent
      tags: uninstall

    - name: Définir la version majeure via ansible_distribution_major_version
      set_fact:
        rhel_major_version: "{{ ansible_distribution_major_version | int }}"
      tags: install

    - name: Déinfir le nom du bon RPM à utiliser
      set_fact:
        tanium_rpm: "TaniumClient-{{ tanium_version }}.rhe{{ rhel_major_version }}.x86_64.rpm"
      tags: install

    - name: Debug - RPM sélectionné
      debug:
        msg: "Version RHEL : {{ rhel_major_version }} - RPM sélectionné : {{ tanium_rpm }}"
      tags: install

    - name: Créer le dossier temporaire local
      file:
        path: "{{ local_dir }}"
        state: directory
        mode: '0755'
      tags: install

    - name: Vérifier la présence du script install
      stat: 
        path: "{{ playbook_dir }}/{{ install_script }}"
      register: check_script

    - name: Vérifier la présence du fichier DAT
      stat:
        path: "{{ playbook_dir }}/{{ tanium_dat }}"
      register: check_dat
      tags: install

    - name: Vérifier la présence du fichier RPM
      stat:
        path: "{{ playbook_dir }}/{{ tanium_rpm }}"
      register: check_rpm
      tags: install

    - name: Echouer si un seul fichier est manquant
      fail:
        msg: "Fichier manquant : script ou DAT ou RPM absent dans le dossier {{playbook_dir}}"
      when: not ( check_script.exists and check_dat.stat.exists and check_rpm.stat.exists )
      tags: install

    - name: Afficher le chemin du playbook (debug)
      debug:
        msg: "Chemin du Playbook : {{ playbook_dir }}"
      tags: install

    - name: Copier le fichier RPM
      copy:
        src: "./{{ tanium_rpm }}"
        dest: "{{ local_dir }}/{{ tanium_rpm }}"
        mode: '0755'
      tags: install

    - name: Copier le fichier DAT
      copy:
        src: "./{{tanium_dat}}"
        dest: "{{ local_dir }}/{{ tanium_dat }}"
        mode: '0755'
      tags: install

    - name: lancer le script d'installation et logger la sortie dans installation.log
      script:
        executable: "bash"
        chdir: "{{ local_dir }}"
        cmd: "{{ local_dir }}/{{ install_script }} {{ tanium_env }} > {{ remote_dir }}/installation.log 2>&1"
      register: install_result
      ignore_errors: true
      tags: install

    - name: Afficher la sortie de l'installation
      debug:
        var: install_result.stdout_lines
      failed_when: install_result.rc > 0
      tags: install

    - name: Pause pour laisser le temps au service tanium de démarrer
      pause:
        seconds: 02
      tags: install

    - name: Vérifier que le service taniumclient est actif
      systemd_service:
        state: started
        name: taniumclient
      tags:
        - install
        - restart

    - name: Afficher le log d'installation
      shell: "cat {{ remote_dir }}/installation.log"
      register: log_output
      tags: install

    - name: Contenu du log d'installation
      debug:
        var: log_output.stdout_lines
      tags: install
